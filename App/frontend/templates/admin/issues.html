{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–¥–∞—á–∞–º–∏ - Library Online{% endblock %}

{% block nav %}
<a href="/admin/dashboard">–ü–∞–Ω–µ–ª—å</a>
<a href="/admin/customers">–ß–∏—Ç–∞—Ç–µ–ª–∏</a>
<a href="/admin/books">–ö–Ω–∏–≥–∏</a>
<a href="/admin/authors">–ê–≤—Ç–æ—Ä—ã</a>
<a href="/admin/issues">–í—ã–¥–∞—á–∏</a>
<a href="/admin/exhibitions">–í—ã—Å—Ç–∞–≤–∫–∏</a>
<a href="/admin/reports">–û—Ç—á–µ—Ç—ã</a>
<span style="margin-left: auto; color: white;">üë®‚Äçüíº {{ user_name or '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' }}</span>
<a href="/auth/logout">–í—ã—Ö–æ–¥</a>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="flex-between">
            <h1 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–¥–∞—á–∞–º–∏ –∫–Ω–∏–≥</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="showImportModal()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Excel</button>
                <button class="btn btn-success" onclick="showIssueModal()">‚ûï –í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É</button>
                <button class="btn btn-info" id="export-csv-btn" onclick="exportIssuesToCSV()" style="display: none;">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
            </div>
        </div>

        <div class="search-bar">
            <input type="text" class="form-control" id="search-input" placeholder="–ü–æ–∏—Å–∫..." />
            <button class="btn btn-primary" onclick="search()">üîç –ü–æ–∏—Å–∫</button>
            <select id="status-filter" class="form-control" style="max-width: 200px;" onchange="loadIssues()">
                <option value="all">–í—Å–µ –≤—ã–¥–∞—á–∏</option>
                <option value="active" selected>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                <option value="returned">–í–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã–µ</option>
            </select>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortIssuesTable('id')" class="sortable-header" style="cursor: pointer; user-select: none; transition: background-color 0.2s;">
                            ID <span id="sort-indicator-id"></span>
                        </th>
                        <th onclick="sortIssuesTable('book_title')" class="sortable-header" style="cursor: pointer; user-select: none; transition: background-color 0.2s;">
                            –ö–Ω–∏–≥–∞ <span id="sort-indicator-book_title"></span>
                        </th>
                        <th onclick="sortIssuesTable('customer_name')" class="sortable-header" style="cursor: pointer; user-select: none; transition: background-color 0.2s;">
                            –ß–∏—Ç–∞—Ç–µ–ª—å <span id="sort-indicator-customer_name"></span>
                        </th>
                        <th onclick="sortIssuesTable('date_issued')" class="sortable-header" style="cursor: pointer; user-select: none; transition: background-color 0.2s;">
                            –î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ <span id="sort-indicator-date_issued"></span>
                        </th>
                        <th onclick="sortIssuesTable('return_date')" class="sortable-header" style="cursor: pointer; user-select: none; transition: background-color 0.2s;">
                            –í–µ—Ä–Ω—É—Ç—å –¥–æ <span id="sort-indicator-return_date"></span>
                        </th>
                        <th onclick="sortIssuesTable('date_return')" class="sortable-header" style="cursor: pointer; user-select: none; transition: background-color 0.2s;">
                            –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ <span id="sort-indicator-date_return"></span>
                        </th>
                        <th onclick="sortIssuesTable('status')" class="sortable-header" style="cursor: pointer; user-select: none; transition: background-color 0.2s;">
                            –°—Ç–∞—Ç—É—Å <span id="sort-indicator-status"></span>
                        </th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="issues-table">
                    <tr><td colspan="7" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Issue Book Modal -->
<div id="issue-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-close" onclick="closeIssueModal()">&times;</span>
            <h2 class="modal-title">–í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É</h2>
        </div>
        <form id="issue-form">
            <div class="form-group">
                <label>–ö–Ω–∏–≥–∞ *</label>
                <select class="form-control" id="book-select" required>
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                </select>
            </div>
            <div class="form-group">
                <label>–ß–∏—Ç–∞—Ç–µ–ª—å *</label>
                <select class="form-control" id="customer-select" required>
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeIssueModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-success">–í—ã–¥–∞—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- Import Excel Modal -->
<div id="import-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <span class="modal-close" onclick="closeImportModal()">&times;</span>
            <h2 class="modal-title">–ò–º–ø–æ—Ä—Ç –≤—ã–¥–∞—á –∏–∑ Excel</h2>
        </div>
        <form id="import-form" enctype="multipart/form-data">
            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª Excel (.xlsx, .xls) *</label>
                <input type="file" class="form-control" id="excel-file" accept=".xlsx,.xls" required />
                <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                    –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≥–æ–ª–æ–≤–∫–∏ (Book ID, Book, Customer ID, Customer, Date of issue, Return date)
                </small>
            </div>
            <div id="import-results" style="display: none;"></div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeImportModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin_issues.js') }}"></script>
{% endblock %}

