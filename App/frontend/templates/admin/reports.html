{% extends "base.html" %}

{% block title %}–û—Ç—á–µ—Ç—ã - Library Online{% endblock %}

{% block nav %}
<a href="/admin/dashboard">–ü–∞–Ω–µ–ª—å</a>
<a href="/admin/customers">–ß–∏—Ç–∞—Ç–µ–ª–∏</a>
<a href="/admin/books">–ö–Ω–∏–≥–∏</a>
<a href="/admin/authors">–ê–≤—Ç–æ—Ä—ã</a>
<a href="/admin/issues">–í—ã–¥–∞—á–∏</a>
<a href="/admin/exhibitions">–í—ã—Å—Ç–∞–≤–∫–∏</a>
<a href="/admin/reports">–û—Ç—á–µ—Ç—ã</a>
<span style="margin-left: auto; color: white;">üë®‚Äçüíº {{ user_name or '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' }}</span>
<a href="/auth/logout">–í—ã—Ö–æ–¥</a>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <h1 class="card-title">–û—Ç—á–µ—Ç—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</h1>
        
        <div class="flex gap-2 mb-3">
            <button class="btn btn-primary" onclick="generateFullReport()">üìä –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç</button>
            <button class="btn btn-danger" onclick="generateOverdueReport()">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏</button>
            <button class="btn btn-success" id="export-csv-btn" onclick="exportToCSV()" style="display: none;">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
            <button class="btn" onclick="clearReport()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div id="report-area" style="background: #f8f9fa; padding: 2rem; border-radius: 5px; min-height: 300px;">
            <p class="text-center" style="color: var(--light-text);">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Store current report data for sorting and export
    let currentReportData = [];
    let currentSortColumn = 'return_date'; // Default sort by "–í–µ—Ä–Ω—É—Ç—å –¥–æ"
    let currentSortDirection = 'asc'; // Default ascending

    // Make functions globally available
    window.generateFullReport = async function() {
        try {
            const report = await apiCall('/api/reports/full');
            const stats = report.statistics;
            
            let html = `
                <h2>–ü–û–õ–ù–´–ô –û–¢–ß–ï–¢ –ë–ò–ë–õ–ò–û–¢–ï–ö–ò</h2>
                <p><strong>–î–∞—Ç–∞:</strong> ${new Date().toLocaleString('ru-RU')}</p>
                <hr>
                
                <h3>–°–¢–ê–¢–ò–°–¢–ò–ö–ê</h3>
                <ul>
                    <li>–í—Å–µ–≥–æ —á–∏—Ç–∞—Ç–µ–ª–µ–π: <strong>${stats.total_customers}</strong></li>
                    <li>–í—Å–µ–≥–æ –∫–Ω–∏–≥: <strong>${stats.total_books}</strong></li>
                    <li>–î–æ—Å—Ç—É–ø–Ω–æ –∫–Ω–∏–≥: <strong>${stats.available_books}</strong></li>
                    <li>–í—Å–µ–≥–æ –≤—ã–¥–∞—á: <strong>${stats.total_issues}</strong></li>
                    <li>–ê–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–¥–∞—á: <strong>${stats.active_issues}</strong></li>
                    <li>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö: <strong>${stats.overdue_issues || 0}</strong></li>
                </ul>
                
                <h3>–¢–û–ü-5 –ß–ò–¢–ê–¢–ï–õ–ï–ô</h3>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–ò–º—è</th>
                            <th>–ö–Ω–∏–≥ –≤–∑—è—Ç–æ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            stats.top_customers.forEach((c, i) => {
                html += `<tr><td>${i+1}</td><td>${c.customer_name}</td><td>${c.count}</td></tr>`;
            });
            
            html += `
                    </tbody>
                </table>
                
                <h3>–ü–û–ü–£–õ–Ø–†–ù–´–ï –ö–ù–ò–ì–ò</h3>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–í—ã–¥–∞—á</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            stats.top_books.forEach((b, i) => {
                html += `<tr><td>${i+1}</td><td>${b.book_title}</td><td>${b.count}</td></tr>`;
            });
            
            html += `
                    </tbody>
                </table>
                
                <h3>–ê–ö–¢–ò–í–ù–´–ï –í–´–î–ê–ß–ò (${report.active_issues.length})</h3>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>–ö–Ω–∏–≥–∞</th>
                            <th>–ß–∏—Ç–∞—Ç–µ–ª—å</th>
                            <th>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            report.active_issues.slice(0, 10).forEach(issue => {
                html += `<tr><td>${issue.book_title}</td><td>${issue.customer_name}</td><td>${issue.date_issued}</td></tr>`;
            });
            
            if (report.active_issues.length > 10) {
                html += `<tr><td colspan="3" class="text-center">... –∏ –µ—â–µ ${report.active_issues.length - 10}</td></tr>`;
            }
            
            html += '</tbody></table>';
            
            document.getElementById('report-area').innerHTML = html;
            showAlert('–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'success');
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: ' + error.message, 'danger');
        }
    }

    window.generateOverdueReport = async function() {
        try {
            const report = await apiCall('/api/reports/overdue');
            
            // Store report data
            currentReportData = report;
            currentSortColumn = 'return_date';
            currentSortDirection = 'asc';
            
            // Sort by return_date ascending by default
            sortReportData();
            
            // Show export button
            document.getElementById('export-csv-btn').style.display = 'inline-block';
            
            displayOverdueReport();
            showAlert('–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'success');
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: ' + error.message, 'danger');
        }
    }

    function sortReportData() {
        if (!currentReportData || currentReportData.length === 0) return;
        
        currentReportData.sort((a, b) => {
            let aVal = a[currentSortColumn];
            let bVal = b[currentSortColumn];
            
            // Handle date strings
            if (currentSortColumn === 'return_date' || currentSortColumn === 'date_issued') {
                aVal = aVal || '9999-12-31'; // Put empty dates at the end
                bVal = bVal || '9999-12-31';
            }
            
            // Handle numeric values
            if (currentSortColumn === 'days_overdue') {
                aVal = parseInt(aVal) || 0;
                bVal = parseInt(bVal) || 0;
            }
            
            // Handle string values
            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }
            
            let comparison = 0;
            if (aVal < bVal) {
                comparison = -1;
            } else if (aVal > bVal) {
                comparison = 1;
            }
            
            return currentSortDirection === 'asc' ? comparison : -comparison;
        });
    }

    window.sortTable = function(column) {
        if (currentSortColumn === column) {
            // Toggle direction if same column
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            // New column, default to ascending
            currentSortColumn = column;
            currentSortDirection = 'asc';
        }
        
        sortReportData();
        displayOverdueReport();
    }

    function displayOverdueReport() {
        let html = `
            <h2>–û–¢–ß–ï–¢ –û –ü–†–û–°–†–û–ß–ï–ù–ù–´–• –ö–ù–ò–ì–ê–•</h2>
            <p><strong>–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞:</strong> ${new Date().toLocaleString('ru-RU')}</p>
            <p><strong>–°–∏—Å—Ç–µ–º–Ω–∞—è –¥–∞—Ç–∞:</strong> 2018-01-01</p>
                <p><strong>–°—Ä–æ–∫ –≤—ã–¥–∞—á–∏:</strong> 21 –¥–µ–Ω—å</p>
            <hr>
        `;
        
        if (currentReportData.length === 0) {
            html += '<p style="color: var(--success-color); font-size: 1.2rem;">‚úì –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥ –Ω–µ—Ç!</p>';
        } else {
            html += `
                <p style="color: var(--danger-color); font-size: 1.2rem;">
                    ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥: <strong>${currentReportData.length}</strong>
                </p>
                <table id="overdue-table" style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                    <thead>
                        <tr>
                            <th onclick="sortTable('book_title')" 
                                class="sortable-header" 
                                style="cursor: pointer; user-select: none; padding: 0.75rem; background: var(--primary-color); color: white; text-align: left; transition: background-color 0.2s;">
                                –ö–Ω–∏–≥–∞ ${getSortIndicator('book_title')}
                            </th>
                            <th onclick="sortTable('customer_name')" 
                                class="sortable-header" 
                                style="cursor: pointer; user-select: none; padding: 0.75rem; background: var(--primary-color); color: white; text-align: left; transition: background-color 0.2s;">
                                –ß–∏—Ç–∞—Ç–µ–ª—å ${getSortIndicator('customer_name')}
                            </th>
                            <th onclick="sortTable('date_issued')" 
                                class="sortable-header" 
                                style="cursor: pointer; user-select: none; padding: 0.75rem; background: var(--primary-color); color: white; text-align: left; transition: background-color 0.2s;">
                                –î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ ${getSortIndicator('date_issued')}
                            </th>
                            <th onclick="sortTable('return_date')" 
                                class="sortable-header" 
                                style="cursor: pointer; user-select: none; padding: 0.75rem; background: var(--primary-color); color: white; text-align: left; transition: background-color 0.2s;">
                                –í–µ—Ä–Ω—É—Ç—å –¥–æ ${getSortIndicator('return_date')}
                            </th>
                            <th onclick="sortTable('days_overdue')" 
                                class="sortable-header" 
                                style="cursor: pointer; user-select: none; padding: 0.75rem; background: var(--primary-color); color: white; text-align: left; transition: background-color 0.2s;">
                                –î–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ ${getSortIndicator('days_overdue')}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            currentReportData.forEach(item => {
                html += `
                    <tr style="background-color: #ffebee;">
                        <td style="padding: 0.75rem; border-bottom: 1px solid #ddd;">${item.book_title}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #ddd;">${item.customer_name}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #ddd;">${item.date_issued}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #ddd;">${item.return_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #ddd; color: var(--danger-color); font-weight: bold;">${item.days_overdue} –¥–Ω–µ–π</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
        }
        
        document.getElementById('report-area').innerHTML = html;
        
        // Add hover effects for sortable headers
        setTimeout(() => {
            const headers = document.querySelectorAll('.sortable-header');
            headers.forEach(header => {
                header.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#043a2d';
                });
                header.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'var(--primary-color)';
                });
            });
        }, 100);
    }

    function getSortIndicator(column) {
        if (currentSortColumn === column) {
            return currentSortDirection === 'asc' ? '‚Üë' : '‚Üì';
        }
        return '';
    }

    window.exportToCSV = function() {
        if (!currentReportData || currentReportData.length === 0) {
            showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
            return;
        }

        // CSV headers
        const headers = ['–ö–Ω–∏–≥–∞', '–ß–∏—Ç–∞—Ç–µ–ª—å', '–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏', '–í–µ—Ä–Ω—É—Ç—å –¥–æ', '–î–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'];
        const csvRows = [headers.join(',')];

        // Add data rows (already sorted)
        currentReportData.forEach(item => {
            const row = [
                `"${item.book_title.replace(/"/g, '""')}"`,
                `"${item.customer_name.replace(/"/g, '""')}"`,
                item.date_issued || '',
                item.return_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
                item.days_overdue || 0
            ];
            csvRows.push(row.join(','));
        });

        // Create CSV content
        const csvContent = csvRows.join('\n');
        
        // Add BOM for UTF-8 to ensure proper encoding in Excel
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        
        // Create download link
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        // Generate filename with current date
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const filename = `–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è_–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ_–∫–Ω–∏–≥–∏_${dateStr}.csv`;
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        
        // Cleanup
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showAlert('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV!', 'success');
    }

    window.clearReport = function() {
        currentReportData = [];
        document.getElementById('report-area').innerHTML = 
            '<p class="text-center" style="color: var(--light-text);">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</p>';
        document.getElementById('export-csv-btn').style.display = 'none';
    }
</script>
{% endblock %}

