{% extends "base.html" %}

{% block title %}–û—Ç—á–µ—Ç—ã - Library Online{% endblock %}

{% block nav %}
<a href="/admin/dashboard">–ü–∞–Ω–µ–ª—å</a>
<a href="/admin/customers">–ß–∏—Ç–∞—Ç–µ–ª–∏</a>
<a href="/admin/books">–ö–Ω–∏–≥–∏</a>
<a href="/admin/issues">–í—ã–¥–∞—á–∏</a>
<a href="/admin/exhibitions">–í—ã—Å—Ç–∞–≤–∫–∏</a>
<a href="/admin/reports">–û—Ç—á–µ—Ç—ã</a>
<span style="margin-left: auto; color: white;">üë®‚Äçüíº {{ user_name or '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' }}</span>
<a href="/auth/logout">–í—ã—Ö–æ–¥</a>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <h1 class="card-title">–û—Ç—á–µ—Ç—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</h1>
        
        <div class="flex gap-2 mb-3">
            <button class="btn btn-primary" onclick="generateFullReport()">üìä –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç</button>
            <button class="btn btn-danger" onclick="generateOverdueReport()">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏</button>
            <button class="btn" onclick="clearReport()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div id="report-area" style="background: #f8f9fa; padding: 2rem; border-radius: 5px; min-height: 300px;">
            <p class="text-center" style="color: var(--light-text);">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    async function generateFullReport() {
        try {
            const report = await apiCall('/api/reports/full');
            const stats = report.statistics;
            
            let html = `
                <h2>–ü–û–õ–ù–´–ô –û–¢–ß–ï–¢ –ë–ò–ë–õ–ò–û–¢–ï–ö–ò</h2>
                <p><strong>–î–∞—Ç–∞:</strong> ${new Date().toLocaleString('ru-RU')}</p>
                <hr>
                
                <h3>–°–¢–ê–¢–ò–°–¢–ò–ö–ê</h3>
                <ul>
                    <li>–í—Å–µ–≥–æ —á–∏—Ç–∞—Ç–µ–ª–µ–π: <strong>${stats.total_customers}</strong></li>
                    <li>–í—Å–µ–≥–æ –∫–Ω–∏–≥: <strong>${stats.total_books}</strong></li>
                    <li>–î–æ—Å—Ç—É–ø–Ω–æ –∫–Ω–∏–≥: <strong>${stats.available_books}</strong></li>
                    <li>–í—Å–µ–≥–æ –≤—ã–¥–∞—á: <strong>${stats.total_issues}</strong></li>
                    <li>–ê–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–¥–∞—á: <strong>${stats.active_issues}</strong></li>
                    <li>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö: <strong>${stats.overdue_issues || 0}</strong></li>
                </ul>
                
                <h3>–¢–û–ü-5 –ß–ò–¢–ê–¢–ï–õ–ï–ô</h3>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–ò–º—è</th>
                            <th>–ö–Ω–∏–≥ –≤–∑—è—Ç–æ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            stats.top_customers.forEach((c, i) => {
                html += `<tr><td>${i+1}</td><td>${c.customer_name}</td><td>${c.count}</td></tr>`;
            });
            
            html += `
                    </tbody>
                </table>
                
                <h3>–ü–û–ü–£–õ–Ø–†–ù–´–ï –ö–ù–ò–ì–ò</h3>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–í—ã–¥–∞—á</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            stats.top_books.forEach((b, i) => {
                html += `<tr><td>${i+1}</td><td>${b.book_title}</td><td>${b.count}</td></tr>`;
            });
            
            html += `
                    </tbody>
                </table>
                
                <h3>–ê–ö–¢–ò–í–ù–´–ï –í–´–î–ê–ß–ò (${report.active_issues.length})</h3>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>–ö–Ω–∏–≥–∞</th>
                            <th>–ß–∏—Ç–∞—Ç–µ–ª—å</th>
                            <th>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            report.active_issues.slice(0, 10).forEach(issue => {
                html += `<tr><td>${issue.book_title}</td><td>${issue.customer_name}</td><td>${issue.date_issued}</td></tr>`;
            });
            
            if (report.active_issues.length > 10) {
                html += `<tr><td colspan="3" class="text-center">... –∏ –µ—â–µ ${report.active_issues.length - 10}</td></tr>`;
            }
            
            html += '</tbody></table>';
            
            document.getElementById('report-area').innerHTML = html;
            showAlert('–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'success');
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: ' + error.message, 'danger');
        }
    }

    async function generateOverdueReport() {
        try {
            const report = await apiCall('/api/reports/overdue');
            
            let html = `
                <h2>–û–¢–ß–ï–¢ –û –ü–†–û–°–†–û–ß–ï–ù–ù–´–• –ö–ù–ò–ì–ê–•</h2>
                <p><strong>–î–∞—Ç–∞:</strong> ${new Date().toLocaleString('ru-RU')}</p>
                <p><strong>–°—Ä–æ–∫ –≤—ã–¥–∞—á–∏:</strong> 14 –¥–Ω–µ–π</p>
                <hr>
            `;
            
            if (report.length === 0) {
                html += '<p style="color: var(--success-color); font-size: 1.2rem;">‚úì –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥ –Ω–µ—Ç!</p>';
            } else {
                html += `
                    <p style="color: var(--danger-color); font-size: 1.2rem;">
                        ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥: <strong>${report.length}</strong>
                    </p>
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>–ö–Ω–∏–≥–∞</th>
                                <th>–ß–∏—Ç–∞—Ç–µ–ª—å</th>
                                <th>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th>
                                <th>–î–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                report.forEach(item => {
                    html += `
                        <tr style="background-color: #ffebee;">
                            <td>${item.book_title}</td>
                            <td>${item.customer_name}</td>
                            <td>${item.date_issued}</td>
                            <td style="color: var(--danger-color); font-weight: bold;">${item.days_overdue} –¥–Ω–µ–π</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            document.getElementById('report-area').innerHTML = html;
            showAlert('–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'success');
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: ' + error.message, 'danger');
        }
    }

    function clearReport() {
        document.getElementById('report-area').innerHTML = 
            '<p class="text-center" style="color: var(--light-text);">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</p>';
    }
</script>
{% endblock %}

