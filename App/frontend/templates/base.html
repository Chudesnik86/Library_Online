<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Library Online{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% block header %}
    <header class="header">
        <div class="header-content">
            <h1>üìö Library Online</h1>
            <nav class="header-nav">
                {% block nav %}{% endblock %}
            </nav>
        </div>
    </header>
    {% endblock %}

    <main>
        {% block content %}{% endblock %}
    </main>

    {% block scripts %}
    <script>
        // Check and restore JWT token on page load
        document.addEventListener('DOMContentLoaded', function() {
            let token = localStorage.getItem('jwt_token');
            
            // If no token in localStorage, try to get from session
            if (!token) {
                fetch('/auth/api/token')
                    .then(response => response.json())
                    .then(data => {
                        if (data.token) {
                            setToken(data.token);
                            token = data.token;
                        }
                    })
                    .catch(() => {});
            }
            
            if (token && !isTokenExpired(token)) {
                // Token is valid, verify it with server
                fetch('/auth/api/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                }).then(response => {
                    if (!response.ok) {
                        // Token invalid, remove it
                        removeToken();
                    }
                }).catch(() => {
                    removeToken();
                });
            } else if (token) {
                // Token expired, remove it
                removeToken();
            }

            // Add logout handler to all logout links
            document.querySelectorAll('a[href="/auth/logout"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    removeToken();
                    window.location.href = '/auth/logout';
                });
            });
        });

        // Utility functions
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '10000';
            alertDiv.style.minWidth = '300px';
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // JWT Token management
        function getToken() {
            return localStorage.getItem('jwt_token');
        }

        function setToken(token) {
            localStorage.setItem('jwt_token', token);
        }

        function removeToken() {
            localStorage.removeItem('jwt_token');
        }

        function isTokenExpired(token) {
            if (!token) return true;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = payload.exp * 1000; // Convert to milliseconds
                return Date.now() >= exp;
            } catch (e) {
                return true;
            }
        }

        // API call helper with JWT token support
        async function apiCall(url, options = {}) {
            try {
                const token = getToken();
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                // Add JWT token to headers if available
                if (token && !isTokenExpired(token)) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(url, {
                    ...options,
                    headers: headers
                });
                
                // If token expired or invalid, try to refresh or redirect to login
                if (response.status === 401) {
                    removeToken();
                    // Only redirect if not already on login page
                    if (!window.location.pathname.includes('/auth/login')) {
                        window.location.href = '/auth/login';
                    }
                    throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Request failed');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
    </script>
    {% endblock %}
</body>
</html>








