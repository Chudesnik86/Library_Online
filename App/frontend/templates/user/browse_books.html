{% extends "base.html" %}

{% block title %}–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–∏–≥–∏ - Library Online{% endblock %}

{% block nav %}
<a href="/user/dashboard">–ì–ª–∞–≤–Ω–∞—è</a>
<a href="/user/browse_books">–ö–Ω–∏–≥–∏</a>
<a href="/user/my_books">–ú–æ–∏ –∫–Ω–∏–≥–∏</a>
<span style="margin-left: auto; color: white;">üìñ {{ user_name or '–ß–∏—Ç–∞—Ç–µ–ª—å' }}</span>
<a href="/auth/logout">–í—ã—Ö–æ–¥</a>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <h1 class="card-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–∏–≥–∏</h1>
        
        <div class="search-bar">
            <input type="text" class="form-control" id="search-input" placeholder="–ü–æ–∏—Å–∫ –∫–Ω–∏–≥..." />
            <button class="btn btn-primary" onclick="searchBooks()">üîç –ü–æ–∏—Å–∫</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ê–≤—Ç–æ—Ä</th>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th>–î–æ—Å—Ç—É–ø–Ω–æ</th>
                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="books-table">
                    <tr><td colspan="5" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const customerId = '{{ customer_id }}';

    async function loadBooks() {
        try {
            const books = await apiCall('/api/books?available=true');
            displayBooks(books);
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥: ' + error.message, 'danger');
        }
    }

    function displayBooks(books) {
        const tbody = document.getElementById('books-table');
        if (books.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">–î–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–∏–≥ –Ω–µ—Ç</td></tr>';
            return;
        }

        tbody.innerHTML = books.map(book => `
            <tr>
                <td><strong>${book.title}</strong></td>
                <td>${book.author || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td>${book.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                <td>${book.available_copies} –∏–∑ ${book.total_copies}</td>
                <td>
                    ${book.available_copies > 0 ? 
                        `<button class="btn btn-success" onclick="borrowBook('${book.id}')">–í–∑—è—Ç—å –∫–Ω–∏–≥—É</button>` :
                        '<span style="color: var(--danger-color);">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞</span>'
                    }
                </td>
            </tr>
        `).join('');
    }

    async function searchBooks() {
        const searchTerm = document.getElementById('search-input').value;
        try {
            const books = await apiCall(`/api/books?search=${encodeURIComponent(searchTerm)}`);
            displayBooks(books.filter(b => b.available_copies > 0));
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message, 'danger');
        }
    }

    async function borrowBook(bookId) {
        if (!confirm('–í—ã —Ö–æ—Ç–∏—Ç–µ –≤–∑—è—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É?')) return;

        try {
            await apiCall('/api/issues', {
                method: 'POST',
                body: JSON.stringify({
                    book_id: bookId,
                    customer_id: customerId
                })
            });
            showAlert('–ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–∞!', 'success');
            loadBooks();
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'danger');
        }
    }

    document.addEventListener('DOMContentLoaded', loadBooks);
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchBooks();
    });
</script>
{% endblock %}

