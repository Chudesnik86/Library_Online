{% extends "base.html" %}

{% block title %}–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–∏–≥–∏ - Library Online{% endblock %}

{% block nav %}
<a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
<a href="/user/browse_books">–ö–Ω–∏–≥–∏</a>
<a href="/user/exhibitions">–í—ã—Å—Ç–∞–≤–∫–∏</a>
{% if customer_id %}
<a href="/user/my_books">–ú–æ–∏ –∫–Ω–∏–≥–∏</a>
<a href="/user/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
<span style="margin-left: auto; color: white;">üìñ {{ user_name or '–ß–∏—Ç–∞—Ç–µ–ª—å' }}</span>
<a href="/auth/logout">–í—ã—Ö–æ–¥</a>
{% endif %}
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <h1 class="card-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–∏–≥–∏</h1>
        
        <div class="search-bar" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 0.75rem; align-items: end;">
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; color: var(--dark-text);">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" id="search-title" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." />
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; color: var(--dark-text);">–ê–≤—Ç–æ—Ä</label>
                    <input type="text" class="form-control" id="search-author" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞–≤—Ç–æ—Ä—É..." />
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; color: var(--dark-text);">–¢–µ–º–∞/–ñ–∞–Ω—Ä</label>
                    <input type="text" class="form-control" id="search-theme" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–µ..." />
                </div>
                <div>
                    <button class="btn btn-primary" onclick="searchBooks()" style="width: 100%;">üîç –ü–æ–∏—Å–∫</button>
                </div>
            </div>
            <button class="btn" onclick="clearSearch()" style="align-self: flex-start; padding: 0.5rem 1rem;">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <!-- Book Details Card (shown on page instead of modal) -->
        <div id="book-details-card" style="display: none; margin-bottom: 2rem;">
            <div class="card" style="background: white; border: 2px solid var(--primary-color);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <h2 style="margin: 0; color: var(--primary-color);">–î–µ—Ç–∞–ª–∏ –∫–Ω–∏–≥–∏</h2>
                    <button class="btn" onclick="closeBookDetails()" style="padding: 0.5rem;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 2rem; align-items: start;">
                    <div style="position: relative;">
                        <img id="book-details-cover" src="" alt="–û–±–ª–æ–∂–∫–∞ –∫–Ω–∏–≥–∏" 
                             style="width: 200px; height: 280px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
                                    background: #F3F4F6; object-fit: cover; display: block;" 
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'280\'%3E%3Crect fill=\'%23E5E7EB\' width=\'200\' height=\'280\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' fill=\'%239CA3AF\' font-size=\'14\'%3E–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏%3C/text%3E%3C/svg%3E';" />
                        <!-- Cover navigation buttons -->
                        <div id="cover-navigation" style="display: none; margin-top: 0.75rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem;">
                            <button id="cover-prev-btn" class="btn" onclick="changeCover(-1)" disabled 
                                    style="padding: 0.5rem; width: 40px; height: 40px; border-radius: 50%; 
                                           display: flex; align-items: center; justify-content: center; 
                                           font-size: 1.2rem; line-height: 1;" 
                                    title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">‚Üê</button>
                            <span id="cover-counter" style="display: flex; align-items: center; padding: 0.4rem 0.75rem; 
                                                             color: var(--dark-text); font-size: 0.9rem; min-width: 50px; 
                                                             justify-content: center;">
                                <span id="cover-current">1</span> / <span id="cover-total">1</span>
                            </span>
                            <button id="cover-next-btn" class="btn" onclick="changeCover(1)" disabled 
                                    style="padding: 0.5rem; width: 40px; height: 40px; border-radius: 50%; 
                                           display: flex; align-items: center; justify-content: center; 
                                           font-size: 1.2rem; line-height: 1;" 
                                    title="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">‚Üí</button>
                        </div>
                    </div>
                    <div>
                        <h3 id="book-details-title-text" style="margin-top: 0; color: var(--primary-color); font-size: 1.5rem;"></h3>
                        <div style="margin-bottom: 1rem;">
                            <p style="margin: 0.5rem 0;"><strong>–ê–≤—Ç–æ—Ä:</strong> <span id="book-details-author">-</span></p>
                            <p style="margin: 0.5rem 0;"><strong>ISBN:</strong> <span id="book-details-isbn">-</span></p>
                            <p style="margin: 0.5rem 0;"><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> <span id="book-details-category">-</span></p>
                            <p style="margin: 0.5rem 0;"><strong>–î–æ—Å—Ç—É–ø–Ω–æ:</strong> <span id="book-details-available"></span> –∏–∑ <span id="book-details-total"></span></p>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--primary-color);">–û–ø–∏—Å–∞–Ω–∏–µ:</h4>
                            <div id="book-details-description" class="scrollable-description" style="max-height: 200px; overflow-y: auto; padding: 0.75rem; 
                                                                      background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px;
                                                                      line-height: 1.6; color: var(--dark-text); white-space: pre-wrap;
                                                                      scrollbar-width: thin; scrollbar-color: var(--primary-color) #E5E7EB;">
                                –û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                            </div>
                        </div>
                        <div style="margin-top: 1.5rem;" id="book-details-actions">
                            <!-- Action buttons will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Books count display -->
        <div id="books-count" style="margin-bottom: 1rem; padding: 0.75rem 1rem; background: #F3F4F6; border-radius: 8px; display: none;">
            <strong style="color: var(--primary-color);">–ù–∞–π–¥–µ–Ω–æ –∫–Ω–∏–≥: <span id="books-count-number">0</span></strong>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ê–≤—Ç–æ—Ä</th>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th>–î–æ—Å—Ç—É–ø–Ω–æ</th>
                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="books-table">
                    <tr><td colspan="5" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
</div>

        <!-- Pagination -->
        <div id="pagination-container" style="display: none; margin-top: 1.5rem; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <div style="color: var(--dark-text);">
                    –ü–æ–∫–∞–∑–∞–Ω–æ <span id="pagination-info-start">0</span> - <span id="pagination-info-end">0</span> –∏–∑ <span id="pagination-info-total">0</span> –∫–Ω–∏–≥
        </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <label style="color: var(--dark-text); font-size: 0.9rem;">–ö–Ω–∏–≥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
                    <select id="pagination-per-page" class="form-control" style="width: auto; padding: 0.25rem 0.5rem;" onchange="changePerPage(parseInt(this.value))">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="15">15</option>
                        <option value="50" selected>50</option>
                    </select>
                </div>
                    </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <button id="pagination-prev" class="btn" onclick="changePage(currentPage - 1)" disabled>‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: var(--dark-text);">–°—Ç—Ä–∞–Ω–∏—Ü–∞</span>
                    <input type="number" id="pagination-page-input" min="1" value="1" 
                           style="width: 60px; padding: 0.25rem 0.5rem; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                           onchange="goToPage(parseInt(this.value))" />
                    <span style="color: var(--dark-text);">–∏–∑ <span id="pagination-total-pages">1</span></span>
                </div>
                <button id="pagination-next" class="btn" onclick="changePage(currentPage + 1)" disabled>–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
            </div>
        </div>
    </div>
</div>

<!-- Author Biography Modal -->
<div id="author-biography-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 class="modal-title" id="author-biography-name">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è –∞–≤—Ç–æ—Ä–∞</h2>
            <span class="modal-close" onclick="closeAuthorBiography()">&times;</span>
        </div>
        <div style="padding: 1.5rem;">
            <div id="author-biography-dates" style="margin-bottom: 1rem; color: var(--dark-text);">
                <!-- Dates will be inserted here -->
                </div>
            <div id="author-biography-content" class="scrollable-description" style="max-height: 400px; overflow-y: auto; padding: 1rem; 
                                                                      background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px;
                                                                      line-height: 1.6; color: var(--dark-text); white-space: pre-wrap;
                                                                      scrollbar-width: thin; scrollbar-color: var(--primary-color) #E5E7EB;">
                –ë–∏–æ–≥—Ä–∞—Ñ–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                    </div>
            <div id="author-wikipedia-button" style="margin-top: 1rem; display: none;">
                <a id="author-wikipedia-link" href="#" target="_blank" rel="noopener noreferrer" 
                   class="btn btn-primary" style="text-decoration: none; display: inline-block;">
                    üåê –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏
                </a>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" onclick="closeAuthorBiography()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const customerId = '{{ customer_id }}' || null; // null for unauthenticated users
    let currentPage = 1;
    let totalPages = 1;
    let totalBooks = 0;
    let booksPerPage = parseInt(localStorage.getItem('booksPerPage')) || 50; // Load from localStorage or default to 50
    let currentSearchParams = {};

    async function loadBooks(page = 1) {
        try {
            currentPage = page;
            currentSearchParams = {};
            const response = await apiCall(`/api/books?available=true&page=${page}&per_page=${booksPerPage}`);
            
            // Handle both old format (array) and new format (object with pagination)
            if (Array.isArray(response)) {
                displayBooks(response, false);
                document.getElementById('pagination-container').style.display = 'none';
            } else {
                displayBooks(response.books || [], false);
                totalPages = response.total_pages || 1;
                totalBooks = response.total || 0;
                updatePagination();
            }
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥: ' + error.message, 'danger');
        }
    }

    function displayBooks(books, showCount = true) {
        const tbody = document.getElementById('books-table');
        const countDiv = document.getElementById('books-count');
        const countNumber = document.getElementById('books-count-number');
        
        // Update count display
        if (books.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">–î–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–∏–≥ –Ω–µ—Ç</td></tr>';
            if (showCount) {
                countDiv.style.display = 'block';
                countNumber.textContent = '0';
            } else {
                countDiv.style.display = 'none';
            }
            return;
        }

        // Show count only if showCount is true (i.e., after search)
        if (showCount) {
            countDiv.style.display = 'block';
            countNumber.textContent = books.length;
        } else {
            countDiv.style.display = 'none';
        }

        tbody.innerHTML = books.map(book => `
            <tr>
                <td>
                    <a href="#" onclick="showBookDetails(${JSON.stringify(book).replace(/"/g, '&quot;')}); return false;" 
                       style="color: var(--primary-color); text-decoration: none; font-weight: 600; cursor: pointer;">
                       <strong>${book.title}</strong>
                    </a>
                </td>
                <td>
                    ${(() => {
                        const authorNames = (book.author_names && book.author_names.length > 0) 
                            ? book.author_names 
                            : (book.author ? book.author.split(',').map(a => a.trim()) : []);
                        if (authorNames.length === 0) {
                            return '–ù–µ —É–∫–∞–∑–∞–Ω';
                        }
                        return authorNames.map((authorName, index) => {
                            const escapedName = authorName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            return `<a href="#" onclick="searchByAuthor('${escapedName}'); return false;" 
                                       style="color: var(--primary-color); text-decoration: none; border-bottom: 1px dotted var(--primary-color); 
                                              cursor: pointer;" 
                                       title="–ù–∞–π—Ç–∏ –≤—Å–µ –∫–Ω–∏–≥–∏ —ç—Ç–æ–≥–æ –∞–≤—Ç–æ—Ä–∞">${authorName}</a>`;
                        }).join(', ');
                    })()}
                </td>
                <td>${book.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                <td>${book.available_copies} –∏–∑ ${book.total_copies}</td>
                <td>
                    ${book.available_copies > 0 ? 
                        '<span style="color: var(--success-color);">–î–æ—Å—Ç—É–ø–Ω–∞</span>' :
                        '<span style="color: var(--danger-color);">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞</span>'
                    }
                </td>
            </tr>
        `).join('');
    }

    async function searchBooks(page = 1) {
        const title = document.getElementById('search-title').value.trim();
        const author = document.getElementById('search-author').value.trim();
        const theme = document.getElementById('search-theme').value.trim();
        
        try {
            currentPage = page;
            currentSearchParams = { title, author, theme };
            
            let url = '/api/books?available=true';
            const params = [];
            
            if (title) params.push(`title=${encodeURIComponent(title)}`);
            if (author) params.push(`author=${encodeURIComponent(author)}`);
            if (theme) params.push(`theme=${encodeURIComponent(theme)}`);
            
            params.push(`page=${page}`);
            params.push(`per_page=${booksPerPage}`);
            
            if (params.length > 0) {
                url += '&' + params.join('&');
            }
            
            const response = await apiCall(url);
            
            // Handle both old format (array) and new format (object with pagination)
            if (Array.isArray(response)) {
                const availableBooks = response.filter(b => b.available_copies > 0);
                displayBooks(availableBooks, true);
                document.getElementById('pagination-container').style.display = 'none';
            } else {
                const availableBooks = (response.books || []).filter(b => b.available_copies > 0);
                displayBooks(availableBooks, true);
                totalPages = response.total_pages || 1;
                totalBooks = response.total || 0;
                updatePagination();
            }
            
            // Close book details when searching
            closeBookDetails();
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message, 'danger');
        }
    }

    // Update pagination controls
    function updatePagination() {
        const container = document.getElementById('pagination-container');
        if (!container) return;
        
        if (totalPages <= 1) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'flex';
        container.style.flexDirection = 'row';
        
        // Update page info
        const start = totalBooks > 0 ? (currentPage - 1) * booksPerPage + 1 : 0;
        const end = Math.min(currentPage * booksPerPage, totalBooks);
        document.getElementById('pagination-info-start').textContent = start;
        document.getElementById('pagination-info-end').textContent = end;
        document.getElementById('pagination-info-total').textContent = totalBooks;
        document.getElementById('pagination-total-pages').textContent = totalPages;
        document.getElementById('pagination-page-input').value = currentPage;
        
        // Update buttons
        document.getElementById('pagination-prev').disabled = currentPage <= 1;
        document.getElementById('pagination-next').disabled = currentPage >= totalPages;
    }

    // Change page
    function changePage(page) {
        if (page < 1 || page > totalPages) return;
        
        // Check if we're in search mode
        const hasSearch = currentSearchParams.title || currentSearchParams.author || currentSearchParams.theme;
        if (hasSearch) {
            searchBooks(page);
        } else {
            loadBooks(page);
        }
    }

    // Go to specific page
    function goToPage(page) {
        if (page < 1) page = 1;
        if (page > totalPages) page = totalPages;
        changePage(page);
    }

    // Show author biography
    async function showAuthorBiography(authorId) {
        if (!authorId) {
            showAlert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'warning');
            return;
        }
        
        try {
            const author = await apiCall(`/api/authors/${authorId}`);
            
            document.getElementById('author-biography-name').textContent = `–ë–∏–æ–≥—Ä–∞—Ñ–∏—è: ${author.full_name}`;
            
            // Display dates
            const datesDiv = document.getElementById('author-biography-dates');
            let datesText = '';
            if (author.birth_date) {
                datesText += `–†–æ–¥–∏–ª—Å—è: ${author.birth_date}`;
            }
            if (author.death_date) {
                datesText += datesText ? ' | ' : '';
                datesText += `–£–º–µ—Ä: ${author.death_date}`;
            }
            datesDiv.textContent = datesText || '';
            datesDiv.style.display = datesText ? 'block' : 'none';
            
            // Display biography
            const biographyDiv = document.getElementById('author-biography-content');
            biographyDiv.textContent = author.biography || '–ë–∏–æ–≥—Ä–∞—Ñ–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
            
            // Show/hide Wikipedia button
            const wikipediaButton = document.getElementById('author-wikipedia-button');
            const wikipediaLink = document.getElementById('author-wikipedia-link');
            if (author.wikipedia_url) {
                wikipediaLink.href = author.wikipedia_url;
                wikipediaButton.style.display = 'block';
            } else {
                wikipediaButton.style.display = 'none';
            }
            
            document.getElementById('author-biography-modal').classList.add('active');
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–æ–≥—Ä–∞—Ñ–∏–∏: ' + error.message, 'danger');
        }
    }

    // Close author biography
    function closeAuthorBiography() {
        document.getElementById('author-biography-modal').classList.remove('active');
    }

    // Change books per page
    function changePerPage(perPage) {
        booksPerPage = perPage;
        localStorage.setItem('booksPerPage', perPage.toString());
        currentPage = 1; // Reset to first page
        const hasSearch = currentSearchParams.title || currentSearchParams.author || currentSearchParams.theme;
        if (hasSearch) {
            searchBooks(1);
        } else {
            loadBooks(1);
        }
    }

    // Search by author (when clicking on author link)
    function searchByAuthor(authorName) {
        document.getElementById('search-author').value = authorName;
        document.getElementById('search-title').value = '';
        document.getElementById('search-theme').value = '';
        closeBookDetails();
        searchBooks(1);
    }

    // Set per page selector on page load
    document.addEventListener('DOMContentLoaded', function() {
        const perPageSelect = document.getElementById('pagination-per-page');
        if (perPageSelect) {
            perPageSelect.value = booksPerPage;
        }
    });
    
    function clearSearch() {
        document.getElementById('search-title').value = '';
        document.getElementById('search-author').value = '';
        document.getElementById('search-theme').value = '';
        document.getElementById('books-count').style.display = 'none'; // Hide count when clearing
        currentSearchParams = {};
        currentPage = 1;
        loadBooks(1);
        closeBookDetails();
    }

    async function borrowBook(bookId) {
        const confirmed = await confirmAction('–í—ã —Ö–æ—Ç–∏—Ç–µ –≤–∑—è—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É?', '–í–∑—è—Ç—å –∫–Ω–∏–≥—É');
        if (!confirmed) return;

        // Redirect to login page (only admin can issue books)
        window.location.href = '/auth/login';
    }

    // Cover navigation
    let currentCovers = [];
    let currentCoverIndex = 0;
    
    // Author biography
    let currentAuthorsInfo = []; // Array of author info objects

    function changeCover(direction) {
        if (currentCovers.length === 0) return;
        
        currentCoverIndex += direction;
        
        if (currentCoverIndex < 0) currentCoverIndex = 0;
        if (currentCoverIndex >= currentCovers.length) currentCoverIndex = currentCovers.length - 1;
        
        updateCoverDisplay();
    }

    function updateCoverDisplay() {
        const coverImg = document.getElementById('book-details-cover');
        const prevBtn = document.getElementById('cover-prev-btn');
        const nextBtn = document.getElementById('cover-next-btn');
        const currentSpan = document.getElementById('cover-current');
        const totalSpan = document.getElementById('cover-total');
        const navDiv = document.getElementById('cover-navigation');
        
        if (currentCovers.length === 0) {
            navDiv.style.display = 'none';
            coverImg.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'280\'%3E%3Crect fill=\'%23E5E7EB\' width=\'200\' height=\'280\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' fill=\'%239CA3AF\' font-size=\'14\'%3E–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏%3C/text%3E%3C/svg%3E';
            return;
        }
        
        navDiv.style.display = 'flex';
        const currentCover = currentCovers[currentCoverIndex];
        coverImg.src = currentCover.file_name || currentCover;
        
        currentSpan.textContent = currentCoverIndex + 1;
        totalSpan.textContent = currentCovers.length;
        
        // Disable buttons at boundaries
        prevBtn.disabled = currentCoverIndex <= 0;
        nextBtn.disabled = currentCoverIndex >= currentCovers.length - 1;
    }

    // Show book details card on page
    function showBookDetails(book) {
        document.getElementById('book-details-title-text').textContent = book.title;
        
        // Load covers
        currentCovers = [];
        if (book.covers && book.covers.length > 0) {
            currentCovers = book.covers.map(c => c.file_name || c);
        } else if (book.cover_image) {
            currentCovers = [book.cover_image];
        }
        currentCoverIndex = 0;
        updateCoverDisplay();
        // Display authors with clickable names for biography - use authors_info if available
        const authorElement = document.getElementById('book-details-author');
        currentAuthorsInfo = [];
        
        if (book.authors_info && book.authors_info.length > 0) {
            // Store all authors with info (have id)
            currentAuthorsInfo = book.authors_info.filter(a => a.id);
            
            // Use authors_info - make names clickable if author has id (for biography)
            authorElement.innerHTML = book.authors_info.map((author, index) => {
                const authorName = author.full_name || author.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä';
                const hasId = author.id;
                const hasWikipedia = author.wikipedia_url;
                
                // If author has id, make name clickable for biography
                if (hasId) {
                    let linkHtml = `<a href="#" onclick="showAuthorBiography(${author.id}); return false;" 
                                       style="color: var(--primary-color); text-decoration: none; border-bottom: 1px dotted var(--primary-color); 
                                              cursor: pointer; margin-right: 0.5rem;" 
                                       title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±–∏–æ–≥—Ä–∞—Ñ–∏—é –∞–≤—Ç–æ—Ä–∞">${authorName}</a>`;
                    
                    // Add Wikipedia link icon if available
                    if (hasWikipedia) {
                        linkHtml += ` <a href="${author.wikipedia_url}" target="_blank" rel="noopener noreferrer" 
                                         style="color: var(--primary-color); text-decoration: none; margin-left: 0.25rem;" 
                                         title="–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–± –∞–≤—Ç–æ—Ä–µ –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏">üîó</a>`;
                    }
                    
                    return linkHtml;
                } else {
                    // No id, just show name with Wikipedia link if available
                    if (hasWikipedia) {
                        return `<span style="margin-right: 0.5rem;">${authorName} <a href="${author.wikipedia_url}" target="_blank" rel="noopener noreferrer" 
                                         style="color: var(--primary-color); text-decoration: none; margin-left: 0.25rem;" 
                                         title="–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–± –∞–≤—Ç–æ—Ä–µ –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏">üîó</a></span>`;
                    } else {
                        return `<span style="margin-right: 0.5rem;">${authorName}</span>`;
                    }
                }
            }).join(', ');
        } else {
            // Fallback to author_names or legacy author field
            const authorNames = book.author_names && book.author_names.length > 0 
                ? book.author_names 
                : (book.author ? book.author.split(',').map(a => a.trim()) : []);
            
            if (authorNames.length === 0) {
                authorElement.textContent = '–ù–µ —É–∫–∞–∑–∞–Ω';
            } else {
                authorElement.innerHTML = authorNames.map((authorName) => {
                    return `<span style="margin-right: 0.5rem;">${authorName}</span>`;
                }).join(', ');
            }
            currentAuthorsInfo = [];
        }
        document.getElementById('book-details-isbn').textContent = book.isbn || '–ù–µ —É–∫–∞–∑–∞–Ω';
        document.getElementById('book-details-category').textContent = book.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        document.getElementById('book-details-available').textContent = book.available_copies;
        document.getElementById('book-details-total').textContent = book.total_copies;
        document.getElementById('book-details-description').textContent = book.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
        
        const coverImg = document.getElementById('book-details-cover');
        if (book.cover_image) {
            coverImg.src = book.cover_image;
        } else {
            coverImg.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'280\'%3E%3Crect fill=\'%23E5E7EB\' width=\'200\' height=\'280\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' fill=\'%239CA3AF\' font-size=\'14\'%3E–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏%3C/text%3E%3C/svg%3E';
        }
        
        // Add action button - removed, only admin can issue books
        const actionsDiv = document.getElementById('book-details-actions');
        if (book.available_copies > 0) {
            actionsDiv.innerHTML = '<span style="color: var(--success-color);">–ö–Ω–∏–≥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞</span>';
        } else {
            actionsDiv.innerHTML = '<span style="color: var(--danger-color);">–ö–Ω–∏–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</span>';
        }
        
        // Show the card and scroll to it
        const card = document.getElementById('book-details-card');
        card.style.display = 'block';
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function closeBookDetails() {
        document.getElementById('book-details-card').style.display = 'none';
    }

    async function borrowBookFromDetails(bookId) {
        // Redirect to login (only admin can issue books)
        window.location.href = '/auth/login';
    }

    // Check if book ID is in URL parameters and load that book
    async function checkUrlForBook() {
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('book');
        
        if (bookId) {
            try {
                // Load the specific book
                const book = await apiCall(`/api/books/${bookId}`);
                if (book) {
                    // Show the book details card
                    showBookDetails(book);
                }
            } catch (error) {
                console.error('Error loading book from URL:', error);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥–∏: ' + error.message, 'danger');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadBooks();
        // Check for book parameter in URL after a short delay to ensure page is loaded
        setTimeout(checkUrlForBook, 500);
    });
    
    // Add Enter key support for search fields
    ['search-title', 'search-author', 'search-theme'].forEach(id => {
        const field = document.getElementById(id);
        if (field) {
            field.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchBooks();
            });
        }
    });
</script>
{% endblock %}

