{% extends "base.html" %}

{% block title %}–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–∏–≥–∏ - Library Online{% endblock %}

{% block nav %}
<a href="/user/dashboard">–ì–ª–∞–≤–Ω–∞—è</a>
<a href="/user/browse_books">–ö–Ω–∏–≥–∏</a>
<a href="/user/my_books">–ú–æ–∏ –∫–Ω–∏–≥–∏</a>
<a href="/user/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
<span style="margin-left: auto; color: white;">üìñ {{ user_name or '–ß–∏—Ç–∞—Ç–µ–ª—å' }}</span>
<a href="/auth/logout">–í—ã—Ö–æ–¥</a>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <h1 class="card-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–∏–≥–∏</h1>
        
        <div class="search-bar">
            <input type="text" class="form-control" id="search-input" placeholder="–ü–æ–∏—Å–∫ –∫–Ω–∏–≥..." />
            <button class="btn btn-primary" onclick="searchBooks()">üîç –ü–æ–∏—Å–∫</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ê–≤—Ç–æ—Ä</th>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th>–î–æ—Å—Ç—É–ø–Ω–æ</th>
                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="books-table">
                    <tr><td colspan="5" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Book Details Modal -->
<div id="book-details-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <span class="modal-close" onclick="closeBookDetailsModal()">&times;</span>
            <h2 class="modal-title" id="book-details-title">–î–µ—Ç–∞–ª–∏ –∫–Ω–∏–≥–∏</h2>
        </div>
        <div style="padding: 1.5rem 0;">
            <div style="display: grid; grid-template-columns: 200px 1fr; gap: 2rem; align-items: start;">
                <div>
                    <img id="book-details-cover" src="" alt="–û–±–ª–æ–∂–∫–∞ –∫–Ω–∏–≥–∏" 
                         style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
                                background: #F3F4F6; min-height: 280px; object-fit: cover; display: block;" 
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'280\'%3E%3Crect fill=\'%23E5E7EB\' width=\'200\' height=\'280\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' fill=\'%239CA3AF\' font-size=\'14\'%3E–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏%3C/text%3E%3C/svg%3E';" />
                </div>
                <div>
                    <h3 id="book-details-title-text" style="margin-top: 0; color: var(--primary-color); font-size: 1.5rem;"></h3>
                    <div style="margin-bottom: 1rem;">
                        <p style="margin: 0.5rem 0;"><strong>–ê–≤—Ç–æ—Ä:</strong> <span id="book-details-author">-</span></p>
                        <p style="margin: 0.5rem 0;"><strong>ISBN:</strong> <span id="book-details-isbn">-</span></p>
                        <p style="margin: 0.5rem 0;"><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> <span id="book-details-category">-</span></p>
                        <p style="margin: 0.5rem 0;"><strong>–î–æ—Å—Ç—É–ø–Ω–æ:</strong> <span id="book-details-available"></span> –∏–∑ <span id="book-details-total"></span></p>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 0.5rem; color: var(--primary-color);">–û–ø–∏—Å–∞–Ω–∏–µ:</h4>
                        <p id="book-details-description" style="line-height: 1.6; color: var(--dark-text); white-space: pre-wrap;">
                            –û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                        </p>
                    </div>
                    <div style="margin-top: 1.5rem;" id="book-details-actions">
                        <!-- Action buttons will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" onclick="closeBookDetailsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const customerId = '{{ customer_id }}';

    async function loadBooks() {
        try {
            const books = await apiCall('/api/books?available=true');
            displayBooks(books);
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥: ' + error.message, 'danger');
        }
    }

    function displayBooks(books) {
        const tbody = document.getElementById('books-table');
        if (books.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">–î–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–∏–≥ –Ω–µ—Ç</td></tr>';
            return;
        }

        tbody.innerHTML = books.map(book => `
            <tr>
                <td>
                    <a href="#" onclick="showBookDetails(${JSON.stringify(book).replace(/"/g, '&quot;')}); return false;" 
                       style="color: var(--primary-color); text-decoration: none; font-weight: 600; cursor: pointer;">
                       <strong>${book.title}</strong>
                    </a>
                </td>
                <td>${book.author || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td>${book.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                <td>${book.available_copies} –∏–∑ ${book.total_copies}</td>
                <td>
                    ${book.available_copies > 0 ? 
                        `<button class="btn btn-success" onclick="borrowBook('${book.id}')">–í–∑—è—Ç—å –∫–Ω–∏–≥—É</button>` :
                        '<span style="color: var(--danger-color);">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞</span>'
                    }
                </td>
            </tr>
        `).join('');
    }

    async function searchBooks() {
        const searchTerm = document.getElementById('search-input').value;
        try {
            const books = await apiCall(`/api/books?search=${encodeURIComponent(searchTerm)}`);
            displayBooks(books.filter(b => b.available_copies > 0));
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message, 'danger');
        }
    }

    async function borrowBook(bookId) {
        const confirmed = await confirmAction('–í—ã —Ö–æ—Ç–∏—Ç–µ –≤–∑—è—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É?', '–í–∑—è—Ç—å –∫–Ω–∏–≥—É');
        if (!confirmed) return;

        try {
            await apiCall('/api/issues', {
                method: 'POST',
                body: JSON.stringify({
                    book_id: bookId,
                    customer_id: customerId
                })
            });
            showAlert('–ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–∞!', 'success');
            loadBooks();
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'danger');
        }
    }

    // Show book details modal
    function showBookDetails(book) {
        document.getElementById('book-details-title-text').textContent = book.title;
        document.getElementById('book-details-author').textContent = book.author || '–ù–µ —É–∫–∞–∑–∞–Ω';
        document.getElementById('book-details-isbn').textContent = book.isbn || '–ù–µ —É–∫–∞–∑–∞–Ω';
        document.getElementById('book-details-category').textContent = book.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        document.getElementById('book-details-available').textContent = book.available_copies;
        document.getElementById('book-details-total').textContent = book.total_copies;
        document.getElementById('book-details-description').textContent = book.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
        
        const coverImg = document.getElementById('book-details-cover');
        if (book.cover_image) {
            coverImg.src = book.cover_image;
        } else {
            coverImg.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'280\'%3E%3Crect fill=\'%23E5E7EB\' width=\'200\' height=\'280\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' fill=\'%239CA3AF\' font-size=\'14\'%3E–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏%3C/text%3E%3C/svg%3E';
        }
        
        // Add action button
        const actionsDiv = document.getElementById('book-details-actions');
        if (book.available_copies > 0) {
            actionsDiv.innerHTML = `<button class="btn btn-success" onclick="borrowBookFromModal('${book.id}')">–í–∑—è—Ç—å –∫–Ω–∏–≥—É</button>`;
        } else {
            actionsDiv.innerHTML = '<span style="color: var(--danger-color);">–ö–Ω–∏–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</span>';
        }
        
        document.getElementById('book-details-modal').classList.add('active');
    }

    function closeBookDetailsModal() {
        document.getElementById('book-details-modal').classList.remove('active');
    }

    // Close book details modal on background click
    document.addEventListener('DOMContentLoaded', function() {
        const bookDetailsModal = document.getElementById('book-details-modal');
        if (bookDetailsModal) {
            bookDetailsModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeBookDetailsModal();
                }
            });
        }
    });

    async function borrowBookFromModal(bookId) {
        closeBookDetailsModal();
        await borrowBook(bookId);
    }

    document.addEventListener('DOMContentLoaded', loadBooks);
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchBooks();
    });
</script>
{% endblock %}

