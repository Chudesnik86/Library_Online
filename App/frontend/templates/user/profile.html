{% extends "base.html" %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - Library Online{% endblock %}

{% block nav %}
<a href="/user/dashboard">–ì–ª–∞–≤–Ω–∞—è</a>
<a href="/user/browse_books">–ö–Ω–∏–≥–∏</a>
<a href="/user/my_books">–ú–æ–∏ –∫–Ω–∏–≥–∏</a>
<a href="/user/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
<span style="margin-left: auto; color: white;">üìñ {{ user_name or '–ß–∏—Ç–∞—Ç–µ–ª—å' }}</span>
<a href="/auth/logout">–í—ã—Ö–æ–¥</a>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <h1 class="card-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
        <p style="color: var(--light-text); margin-bottom: 2rem;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ –ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</p>

        <!-- Profile Form -->
        <form id="profile-form">
            <div style="display: grid; gap: 1.5rem;">
                <h2 style="font-size: 1.25rem; color: var(--primary-color); margin-bottom: 0.5rem;">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                
                <div class="form-group">
                    <label>–ò–º—è *</label>
                    <input type="text" class="form-control" id="profile-name" required />
                </div>

                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" class="form-control" id="profile-email" required />
                </div>

                <div class="form-group">
                    <label>ID —á–∏—Ç–∞—Ç–µ–ª—è</label>
                    <input type="text" class="form-control" id="profile-customer-id" readonly style="background-color: #F3F4F6;" />
                </div>

                <h2 style="font-size: 1.25rem; color: var(--primary-color); margin-top: 1rem; margin-bottom: 0.5rem;">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>

                <div class="form-group">
                    <label>–ê–¥—Ä–µ—Å</label>
                    <input type="text" class="form-control" id="profile-address" />
                </div>

                <div class="form-group">
                    <label>–ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å</label>
                    <input type="number" class="form-control" id="profile-zip" />
                </div>

                <div class="form-group">
                    <label>–ì–æ—Ä–æ–¥</label>
                    <input type="text" class="form-control" id="profile-city" />
                </div>

                <div class="form-group">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" class="form-control" id="profile-phone" />
                </div>

                <h2 style="font-size: 1.25rem; color: var(--primary-color); margin-top: 1rem; margin-bottom: 0.5rem;">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h2>
                <p style="font-size: 0.9rem; color: var(--light-text); margin-bottom: 1rem;">
                    –û—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è –ø—É—Å—Ç—ã–º–∏, –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª—å
                </p>

                <div class="form-group">
                    <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-control" id="profile-current-password" />
                </div>

                <div class="form-group">
                    <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-control" id="profile-new-password" />
                </div>

                <div class="form-group">
                    <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-control" id="profile-confirm-password" />
                </div>
            </div>

            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" onclick="loadProfile()" style="background-color: #E5E7EB; color: var(--dark-text);">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Load profile data
    async function loadProfile() {
        try {
            const profile = await apiCall('/api/profile');
            
            // Fill form fields
            document.getElementById('profile-name').value = profile.name || '';
            document.getElementById('profile-email').value = profile.email || '';
            document.getElementById('profile-customer-id').value = profile.customer_id || '';
            
            if (profile.customer) {
                document.getElementById('profile-address').value = profile.customer.address || '';
                document.getElementById('profile-zip').value = profile.customer.zip || '';
                document.getElementById('profile-city').value = profile.customer.city || '';
                document.getElementById('profile-phone').value = profile.customer.phone || '';
            }
            
            // Clear password fields
            document.getElementById('profile-current-password').value = '';
            document.getElementById('profile-new-password').value = '';
            document.getElementById('profile-confirm-password').value = '';
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'danger');
        }
    }

    // Handle form submission
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('profile-name').value;
        const email = document.getElementById('profile-email').value;
        const currentPassword = document.getElementById('profile-current-password').value;
        const newPassword = document.getElementById('profile-new-password').value;
        const confirmPassword = document.getElementById('profile-confirm-password').value;

        // Validate passwords if provided
        if (newPassword || currentPassword) {
            if (!currentPassword) {
                showAlert('–î–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å', 'danger');
                return;
            }
            if (newPassword.length < 6) {
                showAlert('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'danger');
                return;
            }
            if (newPassword !== confirmPassword) {
                showAlert('–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'danger');
                return;
            }
        }

        const profileData = {
            name: name,
            email: email,
            customer: {
                address: document.getElementById('profile-address').value || null,
                zip: document.getElementById('profile-zip').value ? parseInt(document.getElementById('profile-zip').value) : null,
                city: document.getElementById('profile-city').value || null,
                phone: document.getElementById('profile-phone').value || null
            }
        };

        // Add password fields if provided
        if (newPassword) {
            profileData.password = newPassword;
            profileData.current_password = currentPassword;
        }

        try {
            const result = await apiCall('/api/profile', {
                method: 'PUT',
                body: JSON.stringify(profileData)
            });

            if (result.success) {
                showAlert('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                
                // Update JWT token if new one provided
                if (result.token) {
                    localStorage.setItem('jwt_token', result.token);
                }
                
                // Clear password fields
                document.getElementById('profile-current-password').value = '';
                document.getElementById('profile-new-password').value = '';
                document.getElementById('profile-confirm-password').value = '';
                
                // If password was changed, suggest logout
                if (newPassword) {
                    setTimeout(async () => {
                        const confirmed = await confirmAction(
                            '–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ. –í—ã–π—Ç–∏ —Å–µ–π—á–∞—Å?',
                            '–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è'
                        );
                        if (confirmed) {
                            window.location.href = '/auth/logout';
                        }
                    }, 1000);
                }
            }
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'danger');
        }
    });

    // Load profile on page load
    document.addEventListener('DOMContentLoaded', loadProfile);
</script>
{% endblock %}

